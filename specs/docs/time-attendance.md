# Time & Attendance (การบริหารเวลาและการเข้างาน)

เอกสารนี้อธิบาย module ที่เกี่ยวกับการบันทึกเวลาทำงานและการจัดการสถานที่

---

## การบริหารเวลา (`time-management`)

**หน้าที่หลัก:** จัดการกะการทำงานของพนักงานทั้งองค์กร ตั้งแต่การสร้างกะ, มอบหมายกะให้พนักงาน, ไปจนถึงการติดตามข้อมูลการเข้างานและตรวจจับความผิดปกติ

**ใครใช้ได้บ้าง:**
- **HR Admin / HR Manager** — ใช้งานได้ทุก feature รวมถึงสร้าง/แก้ไขกะ, นำเข้าข้อมูล, และจัดการความผิดปกติ
- **Manager** — ดูข้อมูลกะและการเข้างานของทีมได้ แต่ไม่สามารถสร้างหรือแก้ไขกะ
- **Employee** — ดูข้อมูลกะที่ถูกมอบหมายและปฏิทินการทำงานของตนเองได้

**สิ่งที่ทำได้:**

*การจัดการกะ (Shift Management)*
- ดูรายการกะทั้งหมดที่มีในระบบ พร้อมรายละเอียดเวลาเข้า-ออก, เวลาพัก, และจำนวนชั่วโมงทำงาน
- สร้างกะใหม่ โดยกำหนด รหัสกะ, ชื่อกะ (ภาษาไทยและอังกฤษ), เวลาเริ่ม-สิ้นสุด, เวลาพัก, จำนวนชั่วโมงต่อวัน
- แก้ไขกะที่มีอยู่ (เฉพาะ HR)
- กำหนดประเภทกะพิเศษ เช่น กะกลางคืน (Night Shift) หรือ กะยืดหยุ่น (Flexible Shift) ที่มี Core Hours

*การมอบหมายกะ (Shift Assignments)*
- ดูรายการมอบหมายกะของพนักงานแต่ละคน พร้อมวันที่มีผลบังคับใช้และสถานะ
- กรองรายการมอบหมายตามประเภทกะ
- แก้ไขการมอบหมายกะ เปลี่ยนกะหรือปรับวันที่มีผลบังคับใช้ (เฉพาะ HR)

*ปฏิทินกะ (Shift Calendar)*
- ดูปฏิทินรายเดือนที่แสดงกะของพนักงานแต่ละคน
- เห็นวันหยุดนักขัตฤกษ์ (H), วันลา, และวันหยุดสุดสัปดาห์ในปฏิทินเดียวกัน
- เลื่อนดูเดือนก่อนหน้า/ถัดไป หรือกลับมาที่เดือนปัจจุบัน
- แสดงปีพุทธศักราชเมื่อใช้งานในภาษาไทย

*บันทึกการเข้างาน (Attendance Records)*
- ค้นหาและกรองข้อมูลการเข้างานตามช่วงวันที่, พนักงาน, และสถานะ (มาทำงาน/ขาดงาน/ข้อมูลไม่ครบ)
- ดูเวลาเข้างาน/ออกงานจริง พร้อมแสดงสัญญาณเตือนเมื่อสาย (พร้อมจำนวนนาทีที่สาย) หรือออกก่อนเวลา
- ดูจำนวนชั่วโมงทำงานจริงและชั่วโมงล่วงเวลา (OT) ของแต่ละวัน
- เห็นแหล่งที่มาของข้อมูลการเข้างาน เช่น เครื่องสแกนนิ้ว, แอปมือถือ

*การตรวจจับความผิดปกติ (Anomaly Detection)*
- ดูรายการความผิดปกติที่ตรวจพบ แบ่งตามระดับความรุนแรง: วิกฤต (Critical), สูง (High), ปานกลาง (Medium), ต่ำ (Low)
- ประเภทความผิดปกติที่ตรวจจับได้: มาสาย, ไม่บันทึกออก, ออกก่อนเวลา, OT ที่ไม่ได้รับอนุมัติ, ขาดงานต่อเนื่อง
- รัน Anomaly Detection เพื่ออัปเดตรายการล่าสุด (เฉพาะ HR)
- ปิดเคส (Resolve) ความผิดปกติพร้อมบันทึกหมายเหตุการแก้ไข (เฉพาะ HR)
- ตั้งค่า threshold ของการแจ้งเตือน เช่น จำนวนนาทีที่ถือว่าสาย, จำนวนวันขาดงานต่อเนื่องที่ต้องแจ้งเตือน (เฉพาะ HR)

*นำเข้าข้อมูลการเข้างาน (Import Attendance)*
- นำเข้าข้อมูลการเข้างานจากไฟล์ CSV หรือ Excel ผ่าน Wizard 4 ขั้นตอน
- ดาวน์โหลด Template ไฟล์สำหรับเตรียมข้อมูล
- อัปโหลดไฟล์ด้วยการลากวาง (Drag & Drop) หรือเลือกไฟล์จากเครื่อง
- Map คอลัมน์ของไฟล์เข้ากับ field ในระบบ โดยเลือก Template การ mapping สำเร็จรูปได้
- ตรวจสอบความถูกต้องของข้อมูลก่อน import พร้อมแสดงรายการ error แยกตามแถวและ field
- ดูประวัติการ import ย้อนหลัง รวมถึงจำนวนรายการที่สำเร็จ/ล้มเหลว และดูรายละเอียด error ได้

*สรุปการเข้างานรายเดือน (Monthly Summary)*
- ดูสถิติภาพรวม: จำนวนพนักงาน, อัตราการเข้างาน (%), จำนวนวันมาสาย, ชั่วโมง OT รวม
- ดูสรุปรายแผนก: อัตราการเข้างาน, วันสาย, วันขาด, ชั่วโมง OT ของแต่ละแผนก
- ดูสรุปรายบุคคล: วันที่มาทำงานจริง, วันสาย, วันขาด, ชั่วโมงทำงานรวม, อัตราการเข้างาน
- เลือกดูข้อมูลของเดือนที่ต้องการ
- ส่งออกรายงานสรุป (Export)

**ข้อมูลที่แสดง:**
- รายการกะ: รหัสกะ, ชื่อกะ, เวลาเข้า-ออก, เวลาพัก, จำนวนชั่วโมง, ประเภทกะ (กลางคืน/ยืดหยุ่น), Core Hours
- รายการมอบหมาย: ชื่อพนักงาน, กะที่ได้รับ, วันที่มีผล, สถานะ (active/inactive/pending)
- ปฏิทินรายเดือน: กะของพนักงานแต่ละคนในแต่ละวัน พร้อม legend สี
- บันทึกการเข้างาน: เวลาจริง, สถานะ, ชั่วโมงทำงาน, ชั่วโมง OT, แหล่งข้อมูล
- รายการความผิดปกติ: ประเภท, ระดับความรุนแรง, รายละเอียด, สถานะ (เปิด/แก้ไขแล้ว)
- ประวัติ Import: ชื่อไฟล์, วันที่ import, ช่วงเวลา, จำนวนรายการสำเร็จ/ล้มเหลว, สถานะ

**หมายเหตุ:**
- การสร้างและแก้ไขกะต้องการ permission `manage_shifts` ซึ่งมีเฉพาะ HR Admin และ HR Manager
- การ Resolve anomaly ต้องบันทึกหมายเหตุการแก้ไขทุกครั้ง ไม่สามารถปิดเคสโดยไม่มีเหตุผล
- ไฟล์ที่รองรับสำหรับ Import: `.csv`, `.xlsx`, `.xls`
- ข้อมูล Import จะผ่านการ validate ก่อนนำเข้าจริงเสมอ โดยระบบจะแสดง error รายแถวเพื่อให้แก้ไขได้
- ปฏิทินรองรับการแสดงผลทั้งปีคริสต์ศักราชและพุทธศักราช

---

## การจัดการสถานที่ (`location-management`)

**หน้าที่หลัก:** บริหารโครงสร้างสาขาและสถานที่ขององค์กรในแบบ Hierarchy ตั้งแต่ระดับ Business Zone ลงไปถึงชั้น และจัดการการมอบหมายพนักงานให้แต่ละสถานที่

**ใครใช้ได้บ้าง:**
- **HR Admin** — ใช้งานได้ทุก feature รวมถึงมอบหมายพนักงานให้สถานที่และแก้ไขข้อมูล
- **HR Manager** — ใช้งานได้ทุก feature เช่นเดียวกับ HR Admin
- **Manager / Employee** — ดูข้อมูลสถานที่และ Dashboard ได้ แต่ไม่สามารถมอบหมายพนักงานหรือแก้ไขข้อมูลได้

**สิ่งที่ทำได้:**

*มุมมองโครงสร้างสถานที่ (Hierarchy View)*
- ดูโครงสร้างสถานที่ขององค์กรในรูปแบบ Tree แบบ Expand/Collapse
- สถานที่แบ่งเป็น 7 ระดับ: Business Zone, ภูมิภาค (Region), จังหวัด (Province), อำเภอ (District), สาขา (Branch), อาคาร (Building), ชั้น (Floor)
- ค้นหาสถานที่ด้วยชื่อภาษาไทย, ภาษาอังกฤษ, หรือรหัสสถานที่
- กรองตามประเภทสถานที่และจังหวัด
- คลิกเลือกสถานที่เพื่อดูรายละเอียด: ประเภท, ที่อยู่, จำนวนพนักงาน, สถานที่ย่อย, และพนักงาน 3 คนแรก
- เปิด Google Maps เพื่อดูพิกัดสถานที่ (เฉพาะสถานที่ที่มีพิกัด lat/lng)
- กดดูพนักงานทั้งหมดของสถานที่นั้น
- มอบหมายพนักงานเข้าสถานที่ (เฉพาะ HR Admin)

*มุมมองรายชื่อพนักงานตามสถานที่ (Employee Directory View)*
- ดูรายชื่อพนักงานทั้งองค์กรพร้อมข้อมูลสถานที่ที่ถูกมอบหมาย
- กรองพนักงานตามชื่อ, รหัสพนักงาน, หรือสถานที่
- ดูประเภทการมอบหมาย: Primary (สถานที่หลัก) หรือ Secondary (สถานที่รอง)
- ดูวันที่มีผลบังคับใช้ของการมอบหมาย
- ดูประวัติการย้ายสถานที่ของพนักงาน (Location Assignment History) แบบ Timeline
- แก้ไขการมอบหมายสถานที่ (เฉพาะ HR Admin)
- รองรับ Pagination เมื่อมีพนักงานจำนวนมาก

*มอบหมายพนักงานเข้าสถานที่ (Assign Employee)*
- กรอกรหัสพนักงาน
- เลือกประเภทการมอบหมาย: Primary หรือ Secondary
- ระบุวันที่มีผลบังคับใช้
- บันทึกเหตุผลของการย้าย/มอบหมาย

*มุมมอง Dashboard (Dashboard View)*
- ดู KPI ภาพรวมองค์กร: จำนวนพนักงานทั้งหมด, จำนวนสถานที่ทั้งหมด, จำนวนสาขา, จำนวนจังหวัดที่ครอบคลุม
- ดูกราฟแท่งสัดส่วนพนักงานตามภูมิภาค พร้อมเปอร์เซ็นต์
- ดูตารางจำนวนพนักงานตามจังหวัด เรียงลำดับจากมากไปน้อย
- ดูการกระจายตัวตามประเภทสถานที่ (Business Zone, Region, Province, District, Branch, Building, Floor) พร้อมจำนวน
- คลิกที่ประเภทสถานที่ใน Dashboard เพื่อกรองดูใน Hierarchy View ได้ทันที

**ข้อมูลที่แสดง:**
- โครงสร้างสถานที่: ชื่อ (ไทย/อังกฤษ), รหัสสถานที่, ประเภท, สถานะ (active/inactive), จำนวนพนักงาน
- รายละเอียดสถานที่: ที่อยู่เต็ม, อำเภอ, จังหวัด, รหัสไปรษณีย์, พิกัด GPS, เส้นทาง Hierarchy (Breadcrumb)
- รายชื่อพนักงาน: ชื่อ, รหัส, รูปภาพ, สถานที่ที่ถูกมอบหมาย, ประเภทการมอบหมาย, วันที่มีผล
- ประวัติการมอบหมาย: จากสถานที่ไหน, ไปสถานที่ไหน, วันที่, เหตุผล
- Dashboard: จำนวนพนักงานตามภูมิภาคและจังหวัด, จำนวนสถานที่แยกตามประเภท

**หมายเหตุ:**
- การมอบหมายพนักงานเข้าสถานที่ (Assign Employee) ทำได้เฉพาะ HR Admin เท่านั้น (`RBAC.hasRole('hr_admin')`)
- พนักงานหนึ่งคนสามารถมีสถานที่ได้มากกว่า 1 แห่ง โดยแบ่งเป็น Primary (หลัก) และ Secondary (รอง)
- ทุกการเปลี่ยนแปลงสถานที่จะถูกบันทึกเป็นประวัติ Timeline พร้อมเหตุผล เพื่อให้ตรวจสอบย้อนหลังได้
- ฟังก์ชัน Edit Assignment ยังอยู่ระหว่างการพัฒนา (Not Implemented)
